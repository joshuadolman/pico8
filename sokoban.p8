pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
input={
	fd=3, --facing direction
	d=nil, --movement direction
	ctrl_e_i={},
	cur_ctrl=1,
}

e_def={
	plyr={
		s=63,
	},
	box={
		s=17,
	}
}

entities={}

--(t entity_type) 
function create_entity(t,x,y)
	local e={}
	e.x=x or 6
	e.y=y or 6
	e.t=t
	
	return e
end
-->8
function _init()
	for i=1,3 do
	 add(entities,
	 		create_entity("box",
	 				flr(rnd(16)),
	 				flr(rnd(16)) ))	
	end
	
	
	for i=1,20 do
		add(entities,
	 		create_entity("plyr",
	 				flr(rnd(16)),
	 				flr(rnd(16)) ))	
	end
	
	for i=1,#entities do
	 if entities[i].t=="plyr" then
	 	add(input.ctrl_e_i,i)
	 end
	end
end
-->8
function _update60()
	update_plyr()
end

function update_plyr()
	input.d=nil
	for i=0,3 do
		if btnp(i) then input.d=i end
	end
	if input.d!=nil then
		if input.d==0 then
			entities[input.ctrl_e_i[input.cur_ctrl]].x-=1
		end
		if input.d==1 then
			entities[input.ctrl_e_i[input.cur_ctrl]].x+=1
		end
		if input.d==2 then
			entities[input.ctrl_e_i[input.cur_ctrl]].y-=1
		end
		if input.d==3 then
			entities[input.ctrl_e_i[input.cur_ctrl]].y+=1
		end
	end
	if input.d!=nil then input.fd=input.d end
	if btnp(4) then
		input.cur_ctrl+=1
		if input.cur_ctrl>#input.ctrl_e_i then
			input.cur_ctrl=1
		end
	end
	
end

function update_plyr_()
	local e_index=nil
	if btnp(0) then
		e_index=chck_movepos_for_entity(plyr.x-1,plyr.y)
		if e_index!=nil then
			entities[e_index].x-=1
		end
		plyr.x-=1
	end
	if btnp(1) then
		e_index=chck_movepos_for_entity(plyr.x+1,plyr.y)
		if e_index!=nil then
			entities[e_index].x+=1
		end
		plyr.x+=1
	end
	if btnp(2) then
		e_index=chck_movepos_for_entity(plyr.x,plyr.y-1)
		if e_index!=nil then
			entities[e_index].y-=1
		end
		plyr.y-=1
	end
	if btnp(3) then
		e_index=chck_movepos_for_entity(plyr.x,plyr.y+1)
		if e_index!=nil then
			entities[e_index].y+=1
		end
		plyr.y+=1
	end
	
	plyr.x=mid(0,plyr.x,15)
	plyr.y=mid(0,plyr.y,15)
end

function chck_movepos_for_entity(x,y)
	local e_index
	for i=1,#entities do
		if entities[i].x==x and entities[i].y==y then
			e_index=i
		end
	end
	
	return e_index
end

--x xposition(tiles)
--y yposition(tiles)
--d direction
function chck_entity_move_dir(x,y,d)

end
-->8
function _draw()
	cls(1)
	--map(0,0,0,0,16,16)
	default_tcol()
	draw_entities()
	--draw_plyr()
	print(#input.ctrl_e_i,1,1,9)
end

function draw_plyr()
	spr(15,plyr.x*8,plyr.y*8)
end

function draw_entities()
	local sprite
	for i=1,#entities do
		sprite=e_def[entities[i].t].s
		if entities[i].t=="plyr" then
			spr(1,entities[i].x*8 -1,entities[i].y*8 +2)
		end
		if input.ctrl_e_i[input.cur_ctrl]==i then
			pal(6,12)
			pal(5,4)
			pal(7,15)
			sprite-=(3-input.fd)*16
		end
		spr(sprite,
				entities[i].x*8,
				entities[i].y*8)
		if input.ctrl_e_i[input.cur_ctrl]==i then
			pal()
			default_tcol()
		end
	end
end

function default_tcol()
	palt()
	palt(0,false)
	palt(14,true)
end
__gfx__
00000000eeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0000ee
00000000eeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0550ee
00700700eeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0750ee
00077000eeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
00077000eeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
00700700ee5555ee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
00000000e555555e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
00000000ee5555ee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
00000000ee000eee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0000ee
04444440e06660ee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0550ee
04999940e066650e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0570ee
049999400556660e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
049999400556665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
049999400555665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
044444400555556000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
044444400555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0000ee
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0550ee
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e005500e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e066660e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e066660e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e066660e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e006600e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0000ee
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0550ee
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e007700e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e066660e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e066660e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e066660e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e006600e
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee0660ee
66d6566666666666f444444fffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6d6d66666666666644444fffffffff44000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
665666666666666644fffffffff44444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66d666666667d666fffffffff44444ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666667d6666ff44ffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666666666666fff44fffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666666666666fff4444ffff444ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
766666666666667dfffff4444444444f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
766666666666665df444fff4444fffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666d5444ffffffffff444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
666666666666666d4fffffffffffff44000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666d6ffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6665d66666666666ffffff44f4ffff44000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
666d5566666666664fff444444ffff44000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
666566666666666644444444ffff444f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
766666666666667d4444444fffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55576666656555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
57766666665667550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
57666666666666750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666666666666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666666666666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666666666666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666666666666560000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666666666666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666666666666750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55766666666667550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555557665550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
4041404140414041404140414041404100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051505150515051505150515051505100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041404140414041404140414041404100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051505150515051505150515051505100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041404140414041404140414041404100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051505150515051505150515051505100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041404140414041404140414041404100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051505150515051505150515051505100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041404140414041404140414041404100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051505150515051505150515051505100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041404140414041404140414041404100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051505150515051505150515051505100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041404140414041404140414041404100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051505150515051505150515051505100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041404140414041404140414041404100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5051505150515051505150515051505100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
